<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>設備借出單</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; }
    .group { margin-bottom: 20px; border: 1px dashed #ccc; padding: 10px; position: relative; }
    .dropdown, .row { position: relative; margin-bottom: 10px; }
    .dropbtn {
      background-color: #3498db; color: white;
      padding: 8px 16px; font-size: 14px;
      border: none; cursor: pointer;
    }
    .dropdown-content {
      display: none; position: absolute;
      background-color: #f9f9f9; min-width: 160px;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .dropdown-content.show { display: block; }
    .dropdown-content span {
      display: block; padding: 10px;
      cursor: pointer; background: #fff;
      border-bottom: 1px solid #ddd;
    }
    .popup {
      position: absolute; display: none;
      background-color: white; border: 1px solid #ccc;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      z-index: 9999; min-width: 160px;
    }
    .popup a {
      display: block; padding: 8px 12px;
      color: #333; text-decoration: none;
      cursor: pointer;
    }
    .popup a:hover { background-color: #f1f1f1; }
    .result {
      display: flex; gap: 20px; margin-top: 20px;
      align-items: center; flex-wrap: wrap;
    }
    .level {
      border: 1px solid #d3d3d3;
      background-color: #d3d3d3;
      padding: 8px;
      min-width: 120px;
      font-size: 14px;
    }
    .quantity-wrapper, .borrower-wrapper, .borrow-date-wrapper, .return-date-wrapper {
      display: flex;
      align-items: center;
      font-size: 14px;
    }
    .quantity-wrapper select.quantity-select,
    .borrower-wrapper select.borrower-select {
      font-size: 14px; padding: 4px 6px;
      margin-left: 6px;
      cursor: pointer;
    }
    .borrow-date-wrapper input.borrow-date,
    .return-date-wrapper input.return-date {
      margin-left: 6px;
      padding: 4px 6px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 2px;
      width: 130px;
    }
    #btnExport, #btnAdd {
      margin-top: 15px; padding: 8px 14px;
      font-size: 14px; cursor: pointer;
      background-color: #2ecc71; color: white;
      border: none; border-radius: 4px;
    }
    #btnAdd { background-color: #f39c12; }
    .btnDelete {
      margin-left: auto;
      background-color: #e74c3c;
      border: none; color: white;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<div style="margin-bottom: 10px;">
  借方：
  <input type="text" id="borrowerNameInput" placeholder="請輸入借方名稱" style="padding: 6px; font-size: 14px; width: 200px;" />
</div>

<div id="container"></div>
<button id="btnAdd">➕ 新增欄位</button>
<button id="btnExport">匯出 Word</button>
<div id="popup2" class="popup"></div>
<div id="popup3" class="popup"></div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@7.1.1/build/index.min.js"></script>

<script>
  const { Document, Packer, Paragraph, TextRun, AlignmentType, TabStopType } = docx;

  let groupIndex = 0;
  const container = document.getElementById('container');
  const popup2 = document.getElementById('popup2');
  const popup3 = document.getElementById('popup3');

  const categoryMap = {
    '設備': ['PC','Laptop','monitor','Lan switch box','BW scope','VNA','ECal','LCR meter'],
    '測試用具': ['40G D-Probe','20G D-Probe','SE Probe','DIFF Probe','FX-C7','SCR10'],
    'connector': ['2.4(F)-2.92(F)','2.92(F)-mmpx(F)','2.92(F)-2.92(F)','2.92(M)-2.92(F)','0Ω(M)','50Ω(M)'],
    '樣品': ['DL Standard coupon','PTFE','Dembed board','airline'],
    'tool': ['扭力扳手','電動起子','電子放大鏡','腳踏開關','游標卡尺']
  };

  const thirdLevelData = {
    'PC': ['FPE119R','1L55D2G'],
    'Laptop': ['dynabook','LEGION'],
    'monitor': ['BENQ 22.7"','ViewSonic 27"'],
    'Lan switch box': ['D-Link','TP-Link'],
    'BW scope': ['SN003019','SN003020'],
    '40G D-Probe': ['8814','8821'],
    '20G D-Probe': ['1022','1077','A065'],
    'SE Probe': ['05 0315','05 1044','08 0174','08 0205','10 0091','10 0444','P1650','P2650'],
    'DIFF Probe': ['05 8332','05 8396','08 0111','08 0112','10 0103','10 0548','PD30','IPD-100'],
    'airline': ['24.8Ω','50.28Ω'],
    '扭力扳手': ['MOUNTZ','PACKETMICRO','Luxshare-ICT'],
  };

  const selections = [];

  function createGroup() {
    const idx = groupIndex++;
    const group = document.createElement('div');
    group.className = 'group';
    group.dataset.idx = idx;
    group.innerHTML = `
      <div class="dropdown">
        <button class="dropbtn">選單</button>
        <div class="dropdown-content">
          ${Object.keys(categoryMap).map(key => `<span data-group="${idx}" data-value="${key}">${key}</span>`).join('')}
        </div>
      </div>
      <div class="result">
        <div class="level">類別: <span class="text1"></span></div>
        <div class="level">項目: <span class="text2"></span></div>
        <div class="level">序號: <span class="text3"></span></div>
        <div class="quantity-wrapper" style="margin-left:20px;">
          數量:
          <select class="quantity-select">
            <option value="" selected></option>
            ${[...Array(8)].map((_, i) => `<option>${i+1}</option>`).join('')}
          </select>
        </div>
        <div class="borrower-wrapper" style="margin-left:20px;">
          借出人:
          <select class="borrower-select">
            <option value="" selected></option>
            <option>Stanley</option>
            <option>Albert</option>
            <option>Tim</option>
          </select>
        </div>
        <div class="borrow-date-wrapper" style="margin-left:20px;">
          借出日期:
          <input type="text" class="borrow-date" placeholder="請選擇日期" />
        </div>
        <div class="return-date-wrapper" style="margin-left:20px;">
          歸還日期:
          <input type="text" class="return-date" placeholder="請選擇日期" />
        </div>
        <button class="btnDelete">✖ 刪除欄位</button>
      </div>`;
    container.appendChild(group);

    group.querySelector('.dropbtn').addEventListener('click', e => {
      e.stopPropagation();
      group.querySelector('.dropdown-content').classList.toggle('show');
      popup2.style.display = popup3.style.display = 'none';
    });

    group.querySelectorAll('.dropdown-content span').forEach(span => {
      span.addEventListener('click', e => {
        e.stopPropagation();
        const level1 = span.dataset.value;
        const idx = parseInt(span.dataset.group);
        selections[idx] = { level1, level2: null, level3: null };
        const rect = span.getBoundingClientRect();
        const level2List = categoryMap[level1] || [];

        popup2.innerHTML = level2List.map(item =>
          `<a data-group="${idx}" data-value="${item}">${item}</a>`).join('');
        popup2.style.top = `${rect.bottom + window.scrollY}px`;
        popup2.style.left = `${rect.right + 5 + window.scrollX}px`;
        popup2.style.display = 'block';
        popup3.style.display = 'none';

        const groupEl = container.querySelector(`.group[data-idx="${idx}"]`);
        groupEl.querySelector('.text1').innerText = level1;
        groupEl.querySelector('.text2').innerText = '';
        groupEl.querySelector('.text3').innerText = '';
      });
    });

    group.querySelector('.btnDelete').addEventListener('click', () => {
      container.removeChild(group);
      selections[idx] = null;
      popup2.style.display = popup3.style.display = 'none';
    });

    flatpickr(group.querySelector('.borrow-date'), { dateFormat: "Y-m-d", locale: "zh" });
    flatpickr(group.querySelector('.return-date'), { dateFormat: "Y-m-d", locale: "zh" });
  }

  popup2.addEventListener('click', e => {
    e.stopPropagation();
    if (e.target.tagName === 'A') {
      const idx = +e.target.dataset.group;
      const level2 = e.target.dataset.value;
      selections[idx].level2 = level2;
      const rect = e.target.getBoundingClientRect();
      const third = thirdLevelData[level2] || [];

      const group = container.querySelector(`.group[data-idx="${idx}"]`);
      group.querySelector('.text2').innerText = level2;
      group.querySelector('.text3').innerText = '';

      if (third.length === 0) {
        popup2.style.display = 'none';
        group.querySelector('.dropdown-content').classList.remove('show');
        return;
      }

      popup3.innerHTML = third.map(item =>
        `<a data-group="${idx}" data-value="${item}">${item}</a>`).join('');
      popup3.style.top = `${rect.bottom + window.scrollY}px`;
      popup3.style.left = `${rect.right + 5 + window.scrollX}px`;
      popup3.style.display = 'block';
    }
  });

  popup3.addEventListener('click', e => {
    e.stopPropagation();
    if (e.target.tagName === 'A') {
      const idx = +e.target.dataset.group;
      const level3 = e.target.dataset.value;
      selections[idx].level3 = level3;

      const group = container.querySelector(`.group[data-idx="${idx}"]`);
      group.querySelector('.text3').innerText = level3;

      popup2.style.display = popup3.style.display = 'none';
      group.querySelector('.dropdown-content').classList.remove('show');
    }
  });

  document.addEventListener('click', () => {
    document.querySelectorAll('.dropdown-content').forEach(dd => dd.classList.remove('show'));
    popup2.style.display = popup3.style.display = 'none';
  });

  document.getElementById('btnAdd').addEventListener('click', createGroup);
  createGroup();


  document.getElementById('btnExport').addEventListener('click', async () => {
    const children = [
      new Paragraph({
        children: [
          new TextRun({
            text: "Arcanum Advanced Inc.",
	    font: "Microsoft JhengHei UI",
            size: 20,
          }),
        ],
        alignment: AlignmentType.RIGHT,
        spacing: { after: 0 },
      }),
      new Paragraph({
        children: [
          new TextRun({
            text: "https://www.arcanum-adv.com",
	    font: "Microsoft JhengHei UI",
            size: 20,
          }),
        ],
        alignment: AlignmentType.RIGHT,
        spacing: { after: 300 },
      }),
      new Paragraph({
        children: [
          new TextRun({
            text: '設備借出單',
            bold: true,
	    font: "Microsoft JhengHei UI",
            size: 40
          })
        ],
        spacing: { after: 300 },
        alignment: AlignmentType.CENTER
      })
    ];

    const borrowerName = document.getElementById('borrowerNameInput').value || '______________';

    children.push(new Paragraph({
      children: [new TextRun({ text: `借方：${borrowerName}`, font: "Microsoft JhengHei UI", size: 32 })],
      spacing: { after: 200 }
    }));

    let count = 0;

    selections.forEach((sel, idx) => {
      if (!sel) return;
      const group = container.querySelector(`.group[data-idx="${idx}"]`);
      if (!group) return;

      const qty = group.querySelector('.quantity-select')?.value || '';
      const borrower = group.querySelector('.borrower-select')?.value || '';
      const borrowDate = group.querySelector('.borrow-date')?.value || '';
      const returnDate = group.querySelector('.return-date')?.value || '';

      count++;

      children.push(new Paragraph({ children: [new TextRun({ text: `第 ${count} 項：`, font: "Microsoft JhengHei UI", size: 28 })] }));

      const line1Parts = [];
      if (sel.level1) line1Parts.push(`類別：${sel.level1}`);
      if (sel.level2) line1Parts.push(`項目：${sel.level2}`);
      if (sel.level3) line1Parts.push(`序號：${sel.level3}`);
      if (qty) line1Parts.push(`數量：${qty}`);

      children.push(new Paragraph({
        children: [new TextRun({ text: line1Parts.join('\t'), font: "Microsoft JhengHei UI", size: 28 })]
      }));

      const line2Parts = [];
      if (borrower) line2Parts.push(`借出人：${borrower}`);
      if (borrowDate) line2Parts.push(`借出日期：${borrowDate}`);
      if (returnDate) line2Parts.push(`歸還日期：${returnDate}`);

      children.push(new Paragraph({
        children: [new TextRun({ text: line2Parts.join('\t'), font: "Microsoft JhengHei UI", size: 28 })],
        spacing: { after: 300 }
      }));
    });

    if (count === 0) return alert('沒有資料');

    children.push(new Paragraph({}));

    children.push(new Paragraph({
      tabStops: [
        { type: TabStopType.LEFT, position: 0 },
        { type: TabStopType.RIGHT, position: 9000 },
      ],
      children: [
        new TextRun({ text: `\t借方簽章：______________`, font: "Microsoft JhengHei UI", size: 32 }),
      ],
      spacing: { before: 1000 }
    }));

    const doc = new Document({
      creator: "系統",
      title: "設備借出清單",
      description: "借出內容",
      styles: {
        default: {
          document: {
            run: { font: "Microsoft JhengHei", size: 28 },
            paragraph: { spacing: { line: 276 } }
          }
        }
      },
      sections: [{ properties: {}, children }]
    });

    const blob = await Packer.toBlob(doc);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    a.download = `設備借出單_${formattedDate}.docx`;
    a.click();
  });
</script>
</body>
</html>
